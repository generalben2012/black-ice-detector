# 5단계: 센서 연결 및 테스트

이 문서는 HC-SR04 초음파 센서를 Arduino UNO Q에 연결하고 전체 시스템을 테스트하는 방법을 설명합니다.

## 목표

- HC-SR04 센서를 Arduino UNO Q에 올바르게 연결
- 전체 시스템이 정상적으로 작동하는지 테스트
- 문제 발생 시 해결 방법

## 필요한 부품

- **Arduino UNO Q** (x1)
- **HC-SR04 초음파 센서** (x1)
- **LDR 조도 센서** (x1)
- **10kΩ 저항** (x1) - LDR 분압 회로용
- **점퍼 와이어** (x6)
- **USB-C 케이블** (전원 및 프로그래밍용)

## HC-SR04 센서 개요

HC-SR04는 초음파를 사용하여 거리를 측정하는 센서입니다:

- **측정 범위**: 2cm ~ 400cm
- **정확도**: ±3mm
- **작동 전압**: 5V
- **작동 전류**: 15mA
- **각도**: 15도

### 핀 구성

HC-SR04 센서는 4개의 핀을 가지고 있습니다:

1. **VCC**: 전원 (5V)
2. **GND**: 그라운드
3. **Trig**: 트리거 신호 (입력)
4. **Echo**: 에코 신호 (출력)

## 센서 연결 방법

### 연결 테이블

| HC-SR04 핀 | Arduino UNO Q 핀 | 설명 |
|-----------|-----------------|------|
| VCC | 5V | 전원 공급 (5V) |
| GND | GND | 그라운드 |
| Trig | D2 | 트리거 신호 (출력) |
| Echo | D3 | 에코 신호 (입력) |

### 연결 다이어그램

```
HC-SR04                    Arduino UNO Q
┌─────────┐                ┌──────────┐
│  VCC    │───────────────▶│   5V     │
│  GND    │───────────────▶│   GND    │
│  Trig   │───────────────▶│   D2     │
│  Echo   │───────────────▶│   D3     │
└─────────┘                └──────────┘
```

### 단계별 연결 가이드

1. **전원 연결**
   - HC-SR04의 VCC 핀을 Arduino UNO Q의 5V 핀에 연결
   - HC-SR04의 GND 핀을 Arduino UNO Q의 GND 핀에 연결

2. **신호 핀 연결**
   - HC-SR04의 Trig 핀을 Arduino UNO Q의 D2 핀에 연결
   - HC-SR04의 Echo 핀을 Arduino UNO Q의 D3 핀에 연결

3. **연결 확인**
   - 모든 연결이 확실히 되었는지 확인
   - 와이어가 느슨하지 않은지 확인

### LDR 조도 센서 연결

LDR 조도 센서는 분압 회로(voltage divider)로 구성합니다:

**회로 구성:**
```
5V ──[LDR]──┬──[10kΩ 저항]── GND
             │
            A1
```

**연결 방법:**
1. LDR의 한쪽을 5V에 연결
2. LDR의 다른 쪽을 10kΩ 저항과 연결
3. LDR과 저항의 중간점을 A1에 연결
4. 10kΩ 저항의 다른 쪽을 GND에 연결

**주의사항:**
- Arduino UNO Q에서는 아날로그 핀에 `pinMode()`를 설정하지 않아야 합니다
- 저항 값은 10kΩ을 권장합니다 (다른 값도 가능하지만 측정 범위가 달라집니다)
- 빛을 가리거나 밝히면 값이 변해야 합니다 (0~1023 범위)

### 주의사항

⚠️ **중요:**
- HC-SR04의 VCC는 반드시 **5V**에 연결해야 합니다 (3.3V는 작동하지 않을 수 있습니다)
- Echo 핀은 5V 신호를 출력하지만, Arduino UNO Q의 디지털 핀은 5V를 허용합니다
- 센서를 연결할 때 전원이 꺼져 있는지 확인하세요
- LDR 회로는 분압 회로로 올바르게 구성해야 합니다

## 시스템 테스트

### 1. 하드웨어 연결 확인

연결이 올바른지 시각적으로 확인:

**HC-SR04:**
- [ ] VCC → 5V 연결 확인
- [ ] GND → GND 연결 확인
- [ ] Trig → D2 연결 확인
- [ ] Echo → D3 연결 확인

**LDR 조도 센서:**
- [ ] LDR 한쪽 → 5V 연결 확인
- [ ] LDR 다른 쪽 → 10kΩ 저항 연결 확인
- [ ] LDR과 저항 중간점 → A1 연결 확인
- [ ] 10kΩ 저항 다른 쪽 → GND 연결 확인

### 2. Arduino 스케치 업로드

1. Arduino App Lab에서 프로젝트 열기
2. "Run App" 버튼 클릭
3. 스케치가 자동으로 업로드됩니다

### 3. 시리얼 모니터 확인

Arduino App Lab의 시리얼 모니터에서 다음 메시지를 확인:

```
Distance: 250.0 mm (25.0 cm), Duration: 1457 us, LDR: 512 (50%)
```

이 메시지가 나타나면 스케치가 정상적으로 업로드되고 센서가 작동하는 것입니다.

### 4. 웹 인터페이스 확인

1. 웹 브라우저가 자동으로 열립니다
2. 또는 수동으로 `<board-name>.local:7000`으로 접속
3. 거리 값과 조도 값이 표시되는지 확인

### 5. 거리 측정 테스트

1. **근거리 테스트**
   - 센서 앞 10cm 지점에 물체를 둡니다
   - 웹 인터페이스에 약 10cm가 표시되는지 확인

2. **중거리 테스트**
   - 센서 앞 50cm 지점에 물체를 둡니다
   - 웹 인터페이스에 약 50cm가 표시되는지 확인

3. **원거리 테스트**
   - 센서 앞 200cm 지점에 물체를 둡니다
   - 웹 인터페이스에 약 200cm가 표시되는지 확인

4. **범위 밖 테스트**
   - 센서 앞 1cm 이하 또는 400cm 이상에 물체를 둡니다
   - 웹 인터페이스에 "--" 또는 오류 메시지가 표시되는지 확인

5. **조도 센서 테스트**
   - 빛을 가리면 LDR 값이 감소하는지 확인
   - 빛을 밝히면 LDR 값이 증가하는지 확인
   - 웹 인터페이스에 조도 값이 실시간으로 업데이트되는지 확인

## 문제 해결

### 문제 1: LDR 값이 변하지 않음

**증상:**
- LDR 값이 고정되어 있음 (예: 104~106 사이에서만 변동)
- 빛을 가리거나 밝혀도 값이 변하지 않음

**가능한 원인:**
1. 회로 구성 오류
2. LDR 손상
3. 저항 값 문제
4. A1 핀 연결 오류

**해결 방법:**
1. **회로 확인**
   - 분압 회로가 올바르게 구성되었는지 확인
   - LDR과 저항이 직렬로 연결되어 있는지 확인
   - 중간점이 A1에 연결되었는지 확인

2. **저항 확인**
   - 10kΩ 저항이 올바르게 연결되었는지 확인
   - 저항 값이 너무 크거나 작으면 측정 범위가 제한될 수 있습니다

3. **연결 테스트**
   - A1 핀을 GND에 직접 연결 → 값이 0에 가까워야 함
   - A1 핀을 5V에 직접 연결 → 값이 1023에 가까워야 함
   - 위 테스트가 정상이면 회로 구성을 다시 확인

4. **LDR 교체**
   - 다른 LDR로 테스트하여 LDR 손상 여부 확인

### 문제 2: 거리 값이 표시되지 않음

**증상:**
- 웹 인터페이스에 "--"가 계속 표시됨
- 또는 "측정 범위를 벗어났습니다" 메시지가 표시됨

**가능한 원인:**
1. 센서 연결 오류
2. 센서 손상
3. 측정 범위를 벗어남
4. 전원 공급 문제

**해결 방법:**
1. **연결 확인**
   - 모든 와이어 연결을 다시 확인
   - 와이어가 확실히 연결되었는지 확인

2. **전원 확인**
   - VCC가 5V에 연결되었는지 확인
   - Arduino UNO Q의 전원 LED가 켜져 있는지 확인

3. **센서 테스트**
   - 다른 HC-SR04 센서로 교체하여 테스트
   - 센서가 손상되었을 수 있습니다

4. **거리 확인**
   - 센서 앞 2cm ~ 400cm 범위 내에 물체가 있는지 확인
   - 센서가 물체를 정확히 향하고 있는지 확인

### 문제 3: 거리 값이 부정확함

**증상:**
- 측정된 거리가 실제 거리와 다름
- 거리 값이 계속 변함

**가능한 원인:**
1. 센서 정렬 문제
2. 주변 반사
3. 온도 변화
4. 센서 품질 문제

**해결 방법:**
1. **센서 정렬**
   - 센서가 물체를 정확히 향하도록 조정
   - 센서와 물체 사이에 장애물이 없는지 확인

2. **환경 확인**
   - 센서 주변에 반사되는 물체 제거
   - 부드러운 표면보다 단단한 표면에서 더 정확하게 측정됩니다

3. **온도 보정**
   - 음속은 온도에 따라 변합니다
   - 정확한 측정이 필요하면 온도 보정 공식을 사용하세요

4. **센서 교체**
   - 다른 센서로 테스트하여 센서 품질 문제인지 확인

### 문제 4: WebSocket 연결 실패

**증상:**
- 웹 인터페이스에 "연결 끊김" 메시지 표시
- 거리 값이 업데이트되지 않음

**가능한 원인:**
1. Python 백엔드 오류
2. 네트워크 문제
3. 포트 충돌

**해결 방법:**
1. **앱 재시작**
   - Arduino App Lab에서 앱을 중지하고 다시 실행

2. **브라우저 콘솔 확인**
   - 브라우저 개발자 도구(F12)에서 오류 메시지 확인
   - WebSocket 연결 오류가 있는지 확인

3. **네트워크 확인**
   - Arduino UNO Q와 컴퓨터가 같은 네트워크에 있는지 확인
   - 방화벽이 포트를 차단하고 있는지 확인

### 문제 5: Bridge 통신 오류

**증상:**
- Python 콘솔에 "Error reading distance" 메시지
- 거리 값이 None으로 반환됨

**가능한 원인:**
1. Arduino 스케치가 업로드되지 않음
2. Bridge.provide()가 제대로 설정되지 않음
3. 함수 이름 불일치

**해결 방법:**
1. **스케치 업로드 확인**
   - Arduino App Lab에서 스케치가 성공적으로 업로드되었는지 확인
   - 시리얼 모니터에서 초기화 메시지 확인

2. **Bridge 함수 확인**
   - `sketch.ino`에서 다음 함수들이 제공되는지 확인:
     - `Bridge.provide("get_duration", get_duration)`
     - `Bridge.provide("get_distance_mm", get_distance_mm)`
     - `Bridge.provide("get_ldr_value", get_ldr_value)`
   - `main.py`에서 다음 함수들이 호출되는지 확인:
     - `Bridge.call("get_duration")`
     - `Bridge.call("get_distance_mm")`
     - `Bridge.call("get_ldr_value")`
   - 함수 이름이 일치하는지 확인

3. **앱 재시작**
   - Arduino App Lab에서 앱을 완전히 중지하고 다시 실행

## 성능 최적화

### 업데이트 주기 조정

더 빠른 업데이트가 필요하면:

```python
# python/main.py
UPDATE_INTERVAL = 0.05  # 50ms (20 readings per second)
```

더 느린 업데이트로 배터리 절약:

```python
UPDATE_INTERVAL = 0.5  # 500ms (2 readings per second)
```

### 측정 범위 조정

더 먼 거리를 측정하려면:

```cpp
// sketch/sketch.ino
const float MAX_DISTANCE = 500.0;  // 최대 거리 증가
long duration = pulseIn(ECHO_PIN, HIGH, 50000);  // 타임아웃 증가
```

## 프로젝트 완성 확인

다음 항목을 모두 확인하면 프로젝트가 완성된 것입니다:

- [ ] HC-SR04 센서가 올바르게 연결됨
- [ ] LDR 조도 센서 회로가 올바르게 구성됨
- [ ] Arduino 스케치가 성공적으로 업로드됨
- [ ] 웹 인터페이스가 정상적으로 표시됨
- [ ] 거리 값이 실시간으로 업데이트됨
- [ ] 조도 값이 실시간으로 업데이트됨
- [ ] 근거리, 중거리, 원거리 테스트 모두 통과
- [ ] 조도 센서 테스트 통과 (빛 변화에 반응)
- [ ] 오류 처리 및 상태 표시가 정상 작동

## 다음 단계

프로젝트가 완성되었습니다! 이제 다음과 같은 확장을 고려할 수 있습니다:

- **데이터 로깅**: 거리 값을 파일에 저장
- **알림 기능**: 특정 거리 이하일 때 알림
- **그래프 표시**: 시간에 따른 거리 변화 그래프
- **다중 센서**: 여러 센서를 사용하여 더 넓은 범위 측정
- **모바일 앱**: 모바일 앱으로 거리 모니터링

## 참고 자료

- [HC-SR04 데이터시트](https://cdn.sparkfun.com/datasheets/Sensors/Proximity/HCSR04.pdf)
- [Arduino UNO Q 공식 문서](https://docs.arduino.cc/hardware/uno-q)
- [Arduino App Lab 문서](https://docs.arduino.cc/arduino-cloud/app-lab)

## 체크리스트

- [ ] HC-SR04 센서 연결 완료
- [ ] LDR 조도 센서 회로 구성 완료
- [ ] Arduino 스케치 업로드 완료
- [ ] 웹 인터페이스 접속 확인 완료
- [ ] 거리 측정 테스트 완료
- [ ] 조도 센서 테스트 완료
- [ ] 문제 해결 완료 (필요한 경우)
- [ ] 프로젝트 완성 확인 완료

